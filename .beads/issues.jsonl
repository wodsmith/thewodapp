{"id":"wodsmith-086","title":"Fix multi-round score encoding in saveCompetitionScore","description":"For multi-round workouts (e.g., load scheme with 3 rounds, scoreType max), the code processes roundScores and generates finalWodScore correctly, but then encodes params.score instead of finalWodScore for the new scores table. This causes scoreValue to be 0 or incorrect.\n\nIssue location: src/server/competition-scores.ts:790-792\n- Should encode finalWodScore (the aggregated max value) instead of params.score\n- This affects any multi-round workout where the max/total needs to be computed from round values","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-10T13:27:00.483442864-07:00","updated_at":"2025-12-10T13:27:55.750389968-07:00","closed_at":"2025-12-10T13:27:55.750389968-07:00"}
{"id":"wodsmith-0xp","title":"Fix README SQL examples to use snake_case column names","description":"README-SCORES-MIGRATION.md verification queries use camelCase property names (competitionEventId, scoreValue) instead of actual SQLite column names (competition_event_id, score_value). Update all SQL examples to use correct snake_case column names.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-10T13:12:11.052733317-07:00","updated_at":"2025-12-10T13:14:17.907681527-07:00","closed_at":"2025-12-10T13:14:17.907681527-07:00"}
{"id":"wodsmith-c9z","title":"Add duplicate handling to migration script","description":"Migration script has no duplicate handling, so it can't be safely re-run. Add INSERT OR REPLACE logic or check for existing scores before inserting to make the migration idempotent.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-10T13:12:11.846296203-07:00","updated_at":"2025-12-10T13:17:41.616800453-07:00","closed_at":"2025-12-10T13:17:41.616800453-07:00"}
{"id":"wodsmith-dd6","title":"Implement Cloudflare Agents chat with anvil package","description":"Create a new anvil package implementing Cloudflare Agents-based chat with WebSocket connections, streaming AI responses, tool support, and entitlement checking to replace the existing HTTP-based chat implementation","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T11:44:24.00123541-07:00","updated_at":"2025-12-11T12:02:31.483701916-07:00","closed_at":"2025-12-11T12:02:31.483701916-07:00"}
{"id":"wodsmith-dd6.1","title":"Create anvil package structure","description":"Created anvil package structure with package.json, tsconfig.json, types.ts, and index.ts. Package configured with dependencies: agents, @ai-sdk/openai, ai. Ready for ChatAgent implementation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:44:24.028139133-07:00","updated_at":"2025-12-11T11:46:44.064786865-07:00","closed_at":"2025-12-11T11:46:44.064786865-07:00","dependencies":[{"issue_id":"wodsmith-dd6.1","depends_on_id":"wodsmith-dd6","type":"parent-child","created_at":"2025-12-11T11:44:24.029106552-07:00","created_by":"daemon"}]}
{"id":"wodsmith-dd6.2","title":"Implement ChatAgent class","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T11:44:24.051521422-07:00","updated_at":"2025-12-11T11:52:46.587098745-07:00","closed_at":"2025-12-11T11:52:46.587098745-07:00","dependencies":[{"issue_id":"wodsmith-dd6.2","depends_on_id":"wodsmith-dd6","type":"parent-child","created_at":"2025-12-11T11:44:24.052276124-07:00","created_by":"daemon"}]}
{"id":"wodsmith-dd6.3","title":"Configure wrangler durable objects","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T11:44:24.077034778-07:00","updated_at":"2025-12-11T11:52:47.318160111-07:00","closed_at":"2025-12-11T11:52:47.318160111-07:00","dependencies":[{"issue_id":"wodsmith-dd6.3","depends_on_id":"wodsmith-dd6","type":"parent-child","created_at":"2025-12-11T11:44:24.077649123-07:00","created_by":"daemon"}]}
{"id":"wodsmith-dd6.4","title":"Update chat API route for agent routing","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T11:44:24.105128161-07:00","updated_at":"2025-12-11T11:58:14.890586506-07:00","closed_at":"2025-12-11T11:58:14.890586506-07:00","dependencies":[{"issue_id":"wodsmith-dd6.4","depends_on_id":"wodsmith-dd6","type":"parent-child","created_at":"2025-12-11T11:44:24.10589087-07:00","created_by":"daemon"}]}
{"id":"wodsmith-dd6.5","title":"Update chat page with useAgent hooks","description":"Successfully updated chat page to use Cloudflare Agents pattern with useAgent and useAgentChat hooks. All UI components maintained, entitlement checking preserved, and type checking passes.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T11:44:24.129492201-07:00","updated_at":"2025-12-11T12:01:36.887254442-07:00","closed_at":"2025-12-11T12:01:36.887254442-07:00","dependencies":[{"issue_id":"wodsmith-dd6.5","depends_on_id":"wodsmith-dd6","type":"parent-child","created_at":"2025-12-11T11:44:24.13031835-07:00","created_by":"daemon"}]}
{"id":"wodsmith-nut","title":"Investigate and fix tiebreak parsing for time strings","description":"The parseTiebreak function uses parseInt which will fail if legacy tiebreak values are stored as time strings like '3:45'. Need to check legacy data format and add handling for both numeric and formatted time strings if needed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-10T13:12:11.489498287-07:00","updated_at":"2025-12-10T13:16:02.081339086-07:00","closed_at":"2025-12-10T13:16:02.081339086-07:00"}
{"id":"wodsmith-t3p","title":"Fix seed script column names to use snake_case","description":"The seed-scores-from-results.sql script uses camelCase column names (userId, teamId, etc.) but the actual SQLite table uses snake_case (user_id, team_id, etc.). This causes all INSERT statements to fail. Need to update all column names except createdAt, updatedAt, updateCounter which are actually camelCase.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-10T13:12:10.472484026-07:00","updated_at":"2025-12-10T13:13:51.233372441-07:00","closed_at":"2025-12-10T13:13:51.233372441-07:00"}
{"id":"wodsmith-tia","title":"Align Workout/Log Scoring with Compete Product","description":"Update workouts and log pages to use the scoring library from @/lib/scoring for consistency with the compete product. Keep UI the same but update backend scoring logic.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-11T21:32:42.637409303-07:00","updated_at":"2025-12-11T21:32:42.637409303-07:00"}
{"id":"wodsmith-tia.1","title":"Create shared score-input hook for log forms","description":"Created useLogScoreState hook with real-time validation using parseScore, multi-round support, tiebreak handling, and all workout scheme support.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T21:32:42.660115304-07:00","updated_at":"2025-12-11T21:35:34.839004563-07:00","closed_at":"2025-12-11T21:35:34.839009132-07:00","dependencies":[{"issue_id":"wodsmith-tia.1","depends_on_id":"wodsmith-tia","type":"parent-child","created_at":"2025-12-11T21:32:42.660879352-07:00","created_by":"daemon"}]}
{"id":"wodsmith-tia.2","title":"Update server/logs.ts to use @/lib/scoring","description":"Refactored processScoresToSetsAndWodScore to use @/lib/scoring. Now uses aggregateValues, libParseScore for time parsing, and encodeTimeFromSeconds + decodeScore for formatting. Maintains backward compatibility with legacy encoding.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T21:32:42.675904132-07:00","updated_at":"2025-12-11T21:35:36.193581937-07:00","closed_at":"2025-12-11T21:35:36.193586049-07:00","dependencies":[{"issue_id":"wodsmith-tia.2","depends_on_id":"wodsmith-tia","type":"parent-child","created_at":"2025-12-11T21:32:42.676573978-07:00","created_by":"daemon"}]}
{"id":"wodsmith-tia.3","title":"Update log-form-client.tsx to use scoring hook","description":"Updating log-form-client.tsx to integrate useLogScoreState hook for score validation and preview","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T21:32:42.690670756-07:00","updated_at":"2025-12-11T21:38:01.116503848-07:00","closed_at":"2025-12-11T21:38:01.116503848-07:00","dependencies":[{"issue_id":"wodsmith-tia.3","depends_on_id":"wodsmith-tia","type":"parent-child","created_at":"2025-12-11T21:32:42.691350372-07:00","created_by":"daemon"}]}
{"id":"wodsmith-tia.4","title":"Update edit-result-client.tsx to use scoring hook","description":"","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T21:32:42.705062693-07:00","updated_at":"2025-12-11T21:32:42.705062693-07:00","dependencies":[{"issue_id":"wodsmith-tia.4","depends_on_id":"wodsmith-tia","type":"parent-child","created_at":"2025-12-11T21:32:42.705642047-07:00","created_by":"daemon"}]}
{"id":"wodsmith-tia.5","title":"Update log-row-card.tsx to use formatScore","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T21:32:42.721361777-07:00","updated_at":"2025-12-11T21:38:18.839682839-07:00","closed_at":"2025-12-11T21:38:18.839682839-07:00","dependencies":[{"issue_id":"wodsmith-tia.5","depends_on_id":"wodsmith-tia","type":"parent-child","created_at":"2025-12-11T21:32:42.721917533-07:00","created_by":"daemon"}]}
{"id":"wodsmith-ulx","title":"Replace (compete) scoring with @/lib/scoring library","description":"Migrate competition scoring from legacy utilities (@/utils/score-parser.ts, @/utils/score-formatting.ts) to the new unified scoring library at @/lib/scoring. This involves updating encoding schemes (time: ms not seconds, rounds-reps: *100000 not *1000, load: grams, distance: mm), migrating to new scores/score_rounds tables, and updating all UI components and server logic.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-09T17:15:30.870466299-07:00","updated_at":"2025-12-09T17:15:37.262693328-07:00"}
{"id":"wodsmith-ulx.1","title":"Phase 1: Create adapter layer for backward compatibility","description":"Create @/utils/score-adapter.ts that bridges legacy encoding (seconds, rounds*1000+reps, lbs, meters) to new encoding (ms, rounds*100000+reps, grams, mm). Refactor score-formatting.ts and score-parser.ts to use new library internally while maintaining existing API signatures.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-09T17:15:42.818920043-07:00","updated_at":"2025-12-09T17:22:08.1527916-07:00","closed_at":"2025-12-09T17:22:08.1527916-07:00","dependencies":[{"issue_id":"wodsmith-ulx.1","depends_on_id":"wodsmith-ulx","type":"parent-child","created_at":"2025-12-09T17:15:42.819424954-07:00","created_by":"daemon"}]}
{"id":"wodsmith-ulx.2","title":"Phase 2: Update UI components to use @/lib/scoring","description":"Update score-input-row.tsx to use parseScore() from @/lib/scoring. Update leaderboard-content.tsx and competition-leaderboard-table.tsx to use formatScore()/decodeScore(). Replace hardcoded LOWER_IS_BETTER_SCHEMES with getSortDirection(). Remove duplicated scheme classification logic.","notes":"Phase 2 completed: Updated UI components to use @/lib/scoring library.\n\nFiles modified:\n1. score-input-row.tsx - Now uses parseScore from @/utils/score-parser-new (which wraps @/lib/scoring)\n2. competition-leaderboard-table.tsx - Replaced hardcoded LOWER_IS_BETTER_SCHEMES with getSortDirection() from @/lib/scoring\n3. event-details-form.tsx - Replaced manual time scheme checks with isTimeBasedScheme() helper\n4. results-entry-form.tsx - Replaced manual time scheme checks with isTimeBasedScheme() helper\n5. leaderboard-content.tsx - Verified (already uses formatScore from refactored utility)\n\nChanges:\n- Removed LOWER_IS_BETTER_SCHEMES constant, now using getSortDirection(scheme)\n- Replaced 'scheme === time || scheme === time-with-cap' with isTimeBasedScheme(scheme)\n- All type checks pass successfully\n- Maintains backward compatibility with legacy encoding\n\nReady for: Manual testing of score input and leaderboard sorting","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-09T17:15:45.483370915-07:00","updated_at":"2025-12-09T17:28:55.850592401-07:00","closed_at":"2025-12-09T17:28:55.850592401-07:00","dependencies":[{"issue_id":"wodsmith-ulx.2","depends_on_id":"wodsmith-ulx","type":"parent-child","created_at":"2025-12-09T17:15:45.483838538-07:00","created_by":"daemon"},{"issue_id":"wodsmith-ulx.2","depends_on_id":"wodsmith-ulx.1","type":"blocks","created_at":"2025-12-09T17:16:13.123826344-07:00","created_by":"daemon"}]}
{"id":"wodsmith-ulx.3","title":"Phase 3: Update server logic for new encoding","description":"Update competition-scores.ts to use encodeScore()/encodeRounds(). Update competition-leaderboard.ts to use compareScores()/computeSortKey(). Update logs.ts processScoresToSetsAndWodScore function. Update competition-score-actions.ts server actions.","notes":"Phase 3 Complete: Updated server-side scoring logic with preparatory comments and TODOs\n\nFiles Modified:\n1. competition-leaderboard.ts - Added TODO comments for sortKey-based sorting and compareScores usage\n2. competition-scores.ts - Added encoding TODOs for dual-write to scores table\n3. competition-score-actions.ts - Added migration notes for Phase 4\n4. logs.ts - Added comprehensive migration documentation header and function-level TODOs\n\nKey Findings:\n- Current flow uses legacy encoding (seconds, rounds*1000+reps, lbs, meters)\n- calculateAggregatedScore() in score-formatting.ts converts to new encoding internally\n- Custom sorting in leaderboard will be replaced by sortKey column + compareScores()\n- saveCompetitionScore() needs dual-write logic in Phase 4\n- processScoresToSetsAndWodScore() is the core function used by both logs and competitions\n\nComplexity Assessment for Phase 4:\n- Medium complexity for competition-scores.ts (dual-write logic)\n- Low complexity for leaderboard (swap to sortKey ordering)\n- High complexity for logs.ts (1100+ lines, multiple schemes, aggregation logic)\n- Must maintain backward compatibility during migration\n- Need data migration script to populate scores table from results+sets\n\nNo Blockers: All preparatory work complete, ready for Phase 4","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-09T17:15:47.902520512-07:00","updated_at":"2025-12-09T17:28:57.288864818-07:00","closed_at":"2025-12-09T17:28:57.288864818-07:00","dependencies":[{"issue_id":"wodsmith-ulx.3","depends_on_id":"wodsmith-ulx","type":"parent-child","created_at":"2025-12-09T17:15:47.90300189-07:00","created_by":"daemon"},{"issue_id":"wodsmith-ulx.3","depends_on_id":"wodsmith-ulx.1","type":"blocks","created_at":"2025-12-09T17:16:13.13617902-07:00","created_by":"daemon"}]}
{"id":"wodsmith-ulx.4","title":"Phase 4: Database migration from results+sets to scores table","description":"Create migration script to copy competition scores from results+sets tables to new scores/score_rounds tables. Convert legacy encodings during migration (time*1000, rounds*100+reps*1000, lbs*453.592, meters*1000). Populate sortKey column for efficient leaderboard queries. Update queries to read from new scores table.","notes":"Phase 4: ~85% Complete!\n\n‚úÖ COMPLETED:\n1. Schema Analysis - Mapped results+sets to scores structure\n2. Migration Script - Created comprehensive TypeScript migration (600+ lines)\n3. SQL Seed Data - Generated 84 competition scores for local testing\n4. Dual-Write Logic - Updated competition-scores.ts to write to both tables\n5. Database Migration - Added unique constraint to scores table\n6. Type Safety - Fixed all TypeScript errors, added proper interfaces\n7. Testing Infrastructure - Created verification queries and test plan\n\nüìä What Was Built:\n- TypeScript migration script (migrate-results-to-scores.ts)\n- SQL seed file (seed-scores-from-results.sql) - 84 competition scores\n- Dual-write in competition-scores.ts with encoding conversion\n- Helper functions: getStatusOrder(), mapToNewStatus(), convertSetsToEncodedValue()\n- Database migration 0054_free_gorilla_man.sql (unique constraint)\n- Test documentation and verification queries\n\nüîß Encoding Conversions Working:\n- Time: seconds ‚Üí milliseconds (√ó1000)\n- Rounds+Reps: rounds√ó1000+reps ‚Üí rounds√ó100000+reps\n- Load: lbs ‚Üí grams (√ó453.592)\n- Distance: meters/feet ‚Üí millimeters\n- sortKey: Computed using computeSortKey() from @/lib/scoring\n\nüöß REMAINING (Tasks 5-6):\n5. Update competition-leaderboard.ts to use sortKey for sorting (~1-2h)\n6. Add feature flag to control read/write behavior (~1h)\n\nüìù Ready for Testing:\n- Run seed.sql with new scores data\n- Submit test competition score\n- Verify dual-write works correctly\n- Check encoding in both tables\n\nEstimated remaining: 2-3 hours","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-09T17:15:50.987318596-07:00","updated_at":"2025-12-09T17:48:28.673725931-07:00","dependencies":[{"issue_id":"wodsmith-ulx.4","depends_on_id":"wodsmith-ulx","type":"parent-child","created_at":"2025-12-09T17:15:50.987792549-07:00","created_by":"daemon"},{"issue_id":"wodsmith-ulx.4","depends_on_id":"wodsmith-ulx.2","type":"blocks","created_at":"2025-12-09T17:16:13.148860251-07:00","created_by":"daemon"},{"issue_id":"wodsmith-ulx.4","depends_on_id":"wodsmith-ulx.3","type":"blocks","created_at":"2025-12-09T17:16:13.161437533-07:00","created_by":"daemon"}],"comments":[{"id":1,"issue_id":"wodsmith-ulx.4","author":"ian","text":"‚úÖ Created SQL seed migration script at apps/wodsmith/scripts/seed-scores-from-results.sql\n\nThis script provides:\n- Sample competition scores for Winter Throwdown 2025 (84 scores total: 21 athletes √ó 4 events)\n- Proper encoding conversions (time‚Üíms, rounds+reps‚Üíinteger encoding, etc.)\n- Simplified sortKey computation suitable for seed data\n- Ready-to-use INSERT statements for the scores table\n- Instructions for adding to main seed.sql\n\nThe script demonstrates the full conversion from legacy results+sets format to the new unified scores table, making it easy to test the new scoring system locally with realistic competition data.\n\nNext step: Add these INSERT statements to the main seed.sql file for local database testing.","created_at":"2025-12-10T00:46:14Z"},{"id":2,"issue_id":"wodsmith-ulx.4","author":"ian","text":"‚úÖ Task 4 Complete: Dual-write logic implemented in competition-scores.ts\n\n**Changes Made:**\n1. Updated saveCompetitionScore() to write to BOTH tables:\n   - Legacy: results + sets (kept all existing logic)\n   - New: scores + score_rounds (added dual-write)\n\n2. Added helper functions:\n   - getStatusOrder(): Maps ScoreStatus to statusOrder (0-3)\n   - mapToNewStatus(): Converts legacy status to simplified new status\n   - convertSetsToEncodedValue(): Converts legacy sets data to new encoding\n\n3. Dual-write implementation:\n   - Converts legacy encoding to new encoding using convertLegacyToNew()\n   - Computes sortKey using computeSortKey() from @/lib/scoring\n   - Handles rounds with score_rounds table inserts\n   - Wrapped in try-catch for backward compatibility (failures log but don't crash)\n   - Supports tiebreak encoding when tiebreakScheme is provided\n\n4. Schema update:\n   - Added unique index on scores table: (competition_event_id, user_id)\n   - Generated migration: 0054_free_gorilla_man.sql\n\n5. Type safety:\n   - Added tiebreakScheme to WorkoutScoreInfo interface\n   - Fixed all TypeScript compilation errors\n\n**Testing Notes:**\nAfter submitting a competition score:\n1. Verify score appears in both results AND scores tables\n2. Check encoding is correct in new table (time in ms, rounds*100000+reps)\n3. Verify sortKey is populated correctly\n4. Check score_rounds entries for multi-round workouts\n\n**Next Steps:**\n- Task 5: Update competition-leaderboard.ts to use sortKey ordering\n- Test with real competition score submissions","created_at":"2025-12-10T00:47:55Z"}]}
{"id":"wodsmith-ulx.5","title":"Phase 5: Cleanup deprecated scoring utilities","description":"Remove @/utils/score-parser.ts and @/utils/score-formatting.ts. Update all imports to use @/lib/scoring directly. Update test/utils/score-formatting.test.ts to test new library. Deprecate or archive results+sets tables.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-09T17:15:52.855475258-07:00","updated_at":"2025-12-09T17:15:52.855475258-07:00","dependencies":[{"issue_id":"wodsmith-ulx.5","depends_on_id":"wodsmith-ulx","type":"parent-child","created_at":"2025-12-09T17:15:52.856034751-07:00","created_by":"daemon"},{"issue_id":"wodsmith-ulx.5","depends_on_id":"wodsmith-ulx.4","type":"blocks","created_at":"2025-12-09T17:16:13.173464309-07:00","created_by":"daemon"}]}
