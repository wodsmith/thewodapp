# Competition Location Schema Specification

This document details the database schema changes required for the competition location feature.

## Overview

Two tables will be modified:
1. `competitions` - Add primary competition location fields
2. `competition_venues` - Add optional offsite venue location fields

## Competition Location Fields

### Table: `competitions`

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `location_name` | TEXT | Yes | NULL | Name of the venue/location (e.g., "CrossFit Central Arena") |
| `address_line_1` | TEXT | Yes | NULL | Primary street address |
| `address_line_2` | TEXT | Yes | NULL | Secondary address (suite, building, floor) |
| `city` | TEXT | Yes | NULL | City name |
| `state` | TEXT | Yes | NULL | State, province, or region |
| `postal_code` | TEXT | Yes | NULL | ZIP code or postal code |
| `country` | TEXT | Yes | NULL | Country name or ISO code |
| `location_notes` | TEXT | Yes | NULL | Additional directions, parking info, etc. |

### Drizzle Schema Definition

```typescript
// In src/db/schemas/competitions.ts - Add to competitionsTable

// Location fields
locationName: text('location_name'),
addressLine1: text('address_line_1'),
addressLine2: text('address_line_2'),
city: text('city'),
state: text('state'),
postalCode: text('postal_code'),
country: text('country'),
locationNotes: text('location_notes'),
```

## Venue Location Fields

### Table: `competition_venues`

| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| `location_name` | TEXT | Yes | NULL | Venue-specific location name |
| `address_line_1` | TEXT | Yes | NULL | Primary street address |
| `address_line_2` | TEXT | Yes | NULL | Secondary address |
| `city` | TEXT | Yes | NULL | City name |
| `state` | TEXT | Yes | NULL | State/province/region |
| `postal_code` | TEXT | Yes | NULL | ZIP/postal code |
| `country` | TEXT | Yes | NULL | Country |
| `location_notes` | TEXT | Yes | NULL | Directions specific to this venue |
| `is_offsite` | INTEGER | Yes | 0 | Boolean flag (0=false, 1=true) indicating venue is at different location |

### Drizzle Schema Definition

```typescript
// In src/db/schemas/competitions.ts - Add to competitionVenuesTable

// Venue-specific location (for offsite venues)
locationName: text('location_name'),
addressLine1: text('address_line_1'),
addressLine2: text('address_line_2'),
city: text('city'),
state: text('state'),
postalCode: text('postal_code'),
country: text('country'),
locationNotes: text('location_notes'),
isOffsite: integer('is_offsite', { mode: 'boolean' }).default(false),
```

## SQL Migration

The following SQL represents the migration that will be generated by Drizzle:

```sql
-- Competition location fields
ALTER TABLE competitions ADD COLUMN location_name TEXT;
ALTER TABLE competitions ADD COLUMN address_line_1 TEXT;
ALTER TABLE competitions ADD COLUMN address_line_2 TEXT;
ALTER TABLE competitions ADD COLUMN city TEXT;
ALTER TABLE competitions ADD COLUMN state TEXT;
ALTER TABLE competitions ADD COLUMN postal_code TEXT;
ALTER TABLE competitions ADD COLUMN country TEXT;
ALTER TABLE competitions ADD COLUMN location_notes TEXT;

-- Venue location fields
ALTER TABLE competition_venues ADD COLUMN location_name TEXT;
ALTER TABLE competition_venues ADD COLUMN address_line_1 TEXT;
ALTER TABLE competition_venues ADD COLUMN address_line_2 TEXT;
ALTER TABLE competition_venues ADD COLUMN city TEXT;
ALTER TABLE competition_venues ADD COLUMN state TEXT;
ALTER TABLE competition_venues ADD COLUMN postal_code TEXT;
ALTER TABLE competition_venues ADD COLUMN country TEXT;
ALTER TABLE competition_venues ADD COLUMN location_notes TEXT;
ALTER TABLE competition_venues ADD COLUMN is_offsite INTEGER DEFAULT 0;
```

## Field Constraints & Validation

### Character Limits

| Field | Max Length | Rationale |
|-------|------------|-----------|
| `location_name` | 200 | Generous for venue names with subtitles |
| `address_line_1` | 200 | Standard address length |
| `address_line_2` | 200 | Suite/building info |
| `city` | 100 | Longest city names worldwide |
| `state` | 100 | Full state/province names |
| `postal_code` | 20 | International postal codes vary |
| `country` | 100 | Full country names |
| `location_notes` | 1000 | Detailed directions/parking info |

### Zod Validation Schema

```typescript
import { z } from 'zod';

export const competitionLocationSchema = z.object({
  locationName: z.string().max(200).nullable().optional(),
  addressLine1: z.string().max(200).nullable().optional(),
  addressLine2: z.string().max(200).nullable().optional(),
  city: z.string().max(100).nullable().optional(),
  state: z.string().max(100).nullable().optional(),
  postalCode: z.string().max(20).nullable().optional(),
  country: z.string().max(100).nullable().optional(),
  locationNotes: z.string().max(1000).nullable().optional(),
});

export const venueLocationSchema = competitionLocationSchema.extend({
  isOffsite: z.boolean().optional().default(false),
});

// Type inference
export type CompetitionLocation = z.infer<typeof competitionLocationSchema>;
export type VenueLocation = z.infer<typeof venueLocationSchema>;
```

## Data Model Relationships

```
┌─────────────────────────────────────────────┐
│             competitions                     │
├─────────────────────────────────────────────┤
│ id                                          │
│ name, slug, description                     │
│ organizing_team_id ──────────┐              │
│ competition_team_id          │              │
│ start_date, end_date         │              │
│ competition_type             │              │
│ ...                          │              │
│                              │              │
│ ┌─────────────────────────┐  │              │
│ │ LOCATION FIELDS (NEW)   │  │              │
│ │ location_name           │  │              │
│ │ address_line_1          │  │              │
│ │ address_line_2          │  │              │
│ │ city                    │  │              │
│ │ state                   │  │              │
│ │ postal_code             │  │              │
│ │ country                 │  │              │
│ │ location_notes          │  │              │
│ └─────────────────────────┘  │              │
└─────────────────────────────────────────────┘
                    │
                    │ 1:many
                    ▼
┌─────────────────────────────────────────────┐
│         competition_venues                   │
├─────────────────────────────────────────────┤
│ id                                          │
│ competition_id ──────────────────────────── │
│ name                                        │
│ lane_count, transition_minutes              │
│ sort_order                                  │
│                                             │
│ ┌─────────────────────────┐                 │
│ │ LOCATION FIELDS (NEW)   │                 │
│ │ is_offsite              │                 │
│ │ location_name           │                 │
│ │ address_line_1          │                 │
│ │ address_line_2          │                 │
│ │ city                    │                 │
│ │ state                   │                 │
│ │ postal_code             │                 │
│ │ country                 │                 │
│ │ location_notes          │                 │
│ └─────────────────────────┘                 │
└─────────────────────────────────────────────┘
```

## Location Logic

### Competition Location Display Priority

When displaying a competition's location badge:

```
1. competitionType === 'online'
   → Display "Online" with globe icon

2. city && state (US-style)
   → Display "{city}, {state}"
   → Example: "Austin, TX"

3. city && country (international)
   → Display "{city}, {country}"
   → Example: "London, UK"

4. city only
   → Display "{city}"

5. locationName only
   → Display "{locationName}"

6. organizingTeam.name exists
   → Display "{organizingTeam.name}"

7. No location data
   → Display "Location TBA"
```

### Venue Location Logic

```
IF venue.isOffsite === false OR venue has no location data:
  → Venue is at main competition location
  → Display venue name only (e.g., "Main Floor")

IF venue.isOffsite === true AND venue has location data:
  → Venue is at a different location
  → Display venue name with location (e.g., "YMCA Pool @ 456 Oak St")
```

## Index Considerations

No indexes are recommended for location fields initially because:
1. Location fields are not used for filtering in list queries
2. Competitions are filtered by status, dates, and organizing team
3. Future: If location-based search is added, consider indexing `city` and `country`

## Migration Commands

```bash
# During development (direct schema push)
cd apps/wodsmith-start
pnpm db:push

# Before merging to main (generate migration file)
pnpm db:generate --name=add-competition-location
```

## Backwards Compatibility

- All new fields are nullable with no defaults (except `is_offsite` which defaults to `false`)
- Existing competitions will have NULL location values
- UI must handle null values gracefully
- Location display falls back to organizing team name (current behavior)
- No data migration required - existing data unchanged

## Example Data

### Competition with Full Location

```json
{
  "id": "comp_123",
  "name": "Summer Showdown 2025",
  "competitionType": "in-person",
  "locationName": "CrossFit Central Arena",
  "addressLine1": "123 Main Street",
  "addressLine2": "Building C",
  "city": "Austin",
  "state": "TX",
  "postalCode": "78701",
  "country": "United States",
  "locationNotes": "Free parking available in the lot behind the building. Enter through the side door marked 'Competition Entrance'."
}
```

### Online Competition

```json
{
  "id": "comp_456",
  "name": "Virtual Open 2025",
  "competitionType": "online",
  "locationName": null,
  "addressLine1": null,
  "city": null,
  "state": null,
  "country": null
}
```

### Venue with Offsite Location

```json
{
  "id": "venue_789",
  "competitionId": "comp_123",
  "name": "Swimming Events",
  "laneCount": 6,
  "isOffsite": true,
  "locationName": "Austin Aquatics Center",
  "addressLine1": "456 Pool Lane",
  "city": "Austin",
  "state": "TX",
  "postalCode": "78702",
  "locationNotes": "Enter through the north entrance. Athlete check-in at the front desk."
}
```

### Venue at Main Location

```json
{
  "id": "venue_790",
  "competitionId": "comp_123",
  "name": "Main Floor",
  "laneCount": 10,
  "isOffsite": false,
  "locationName": null,
  "addressLine1": null,
  "city": null
}
```
