name: CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}
  FORCE_COLOR: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Generate Alchemy wrangler config for CI
        run: |
          mkdir -p apps/wodsmith-start/.alchemy/local
          cat > apps/wodsmith-start/.alchemy/local/wrangler.jsonc << 'EOF'
          {
            "name": "wodsmith-app-ci",
            "main": "@tanstack/react-start/server-entry",
            "compatibility_date": "2025-12-17",
            "compatibility_flags": ["nodejs_compat", "nodejs_compat_populate_process_env"],
            "assets": {
              "directory": "../../dist/client",
              "binding": "ASSETS",
              "not_found_handling": "none",
              "html_handling": "auto-trailing-slash",
              "run_worker_first": false
            },
            "kv_namespaces": [{ "binding": "KV_SESSION", "id": "ci-placeholder" }],
            "r2_buckets": [{ "binding": "R2_BUCKET", "bucket_name": "ci-placeholder" }],
            "d1_databases": [{
              "binding": "DB",
              "database_id": "ci-placeholder",
              "database_name": "ci-placeholder",
              "migrations_dir": "./src/db/migrations"
            }],
            "vars": {}
          }
          EOF
      - run: pnpm turbo build --filter=wodsmith-start
      - uses: actions/cache/save@v4
        with:
          path: .turbo
          key: turbo-${{ github.sha }}

  test:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - uses: actions/cache/restore@v4
        with:
          path: .turbo
          key: turbo-${{ github.sha }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm turbo test --filter=wodsmith-start
        env:
          NODE_ENV: test

  typecheck:
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - uses: actions/cache/restore@v4
        with:
          path: .turbo
          key: turbo-${{ github.sha }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm turbo type-check --filter=wodsmith-start

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm turbo lint --filter=wodsmith-start
