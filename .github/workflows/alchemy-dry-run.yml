name: Alchemy Infrastructure Preview

on:
  pull_request:
    types:
      - opened
      - synchronize
    paths:
      - 'apps/wodsmith-start/alchemy.run.ts'
      - 'apps/wodsmith-start/wrangler.jsonc'
      - 'apps/docs/alchemy.run.ts'

permissions:
  contents: read
  pull-requests: write

env:
  STAGE: pr-${{ github.event.pull_request.number }}

jobs:
  preview-changes:
    runs-on: ubuntu-latest
    name: Preview Infrastructure Changes
    defaults:
      run:
        working-directory: apps/wodsmith-start
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Run Alchemy dry run
        id: dry-run
        run: |
          set -o pipefail

          # Run alchemy in read mode and capture output
          echo "Running Alchemy in dry-run mode (--read)..."

          # Create output file
          OUTPUT_FILE=$(mktemp)

          # Run alchemy with --read flag and capture both stdout and stderr
          if bun ./alchemy.run.ts --read 2>&1 | tee "$OUTPUT_FILE"; then
            echo "dry_run_success=true" >> $GITHUB_OUTPUT
          else
            echo "dry_run_success=false" >> $GITHUB_OUTPUT
          fi

          # Parse the output to extract resource changes
          CREATES=$(grep -c "Create" "$OUTPUT_FILE" 2>/dev/null || echo "0")
          UPDATES=$(grep -c "Update" "$OUTPUT_FILE" 2>/dev/null || echo "0")
          DELETES=$(grep -c "Delete" "$OUTPUT_FILE" 2>/dev/null || echo "0")

          echo "creates=$CREATES" >> $GITHUB_OUTPUT
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT
          echo "deletes=$DELETES" >> $GITHUB_OUTPUT

          # Save full output for the comment
          {
            echo 'output<<EOF'
            cat "$OUTPUT_FILE" | head -200
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          rm -f "$OUTPUT_FILE"
        env:
          STAGE: ${{ env.STAGE }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          ALCHEMY_PASSWORD: ${{ secrets.ALCHEMY_PASSWORD }}
          ALCHEMY_STATE_TOKEN: ${{ secrets.ALCHEMY_STATE_TOKEN }}
          APP_URL: https://wodsmith-app-${{ env.STAGE }}.zacjones93.workers.dev
          # Secrets for all environments
          TURNSTILE_SECRET_KEY: ${{ secrets.TURNSTILE_SECRET_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          # AI configuration (optional)
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BRAINTRUST_API_KEY: ${{ secrets.BRAINTRUST_API_KEY }}

      - name: Generate report
        id: report
        run: |
          cat > /tmp/report.md << 'EOF'
          ## Alchemy Infrastructure Preview

          This PR modifies infrastructure configuration. Below is the dry-run output showing what would change when deployed.

          EOF

          # Add summary
          echo "### Summary" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo "| Action | Count |" >> /tmp/report.md
          echo "|--------|-------|" >> /tmp/report.md
          echo "| Create | ${{ steps.dry-run.outputs.creates }} |" >> /tmp/report.md
          echo "| Update | ${{ steps.dry-run.outputs.updates }} |" >> /tmp/report.md
          echo "| Delete | ${{ steps.dry-run.outputs.deletes }} |" >> /tmp/report.md
          echo "" >> /tmp/report.md

          # Add status indicator
          if [ "${{ steps.dry-run.outputs.dry_run_success }}" = "true" ]; then
            echo "> **Status:** Dry run completed successfully" >> /tmp/report.md
          else
            echo "> **Warning:** Dry run encountered errors - review output below" >> /tmp/report.md
          fi
          echo "" >> /tmp/report.md

          # Add the full output in a collapsible section
          echo "### Alchemy Output" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo "<details>" >> /tmp/report.md
          echo "<summary>View full dry-run output</summary>" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo '```' >> /tmp/report.md
          echo "${{ steps.dry-run.outputs.output }}" >> /tmp/report.md
          echo '```' >> /tmp/report.md
          echo "</details>" >> /tmp/report.md
          echo "" >> /tmp/report.md

          # Add stage info
          echo "---" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo "*Stage:* \`${{ env.STAGE }}\` | *Commit:* \`${{ github.sha }}\`" >> /tmp/report.md
        working-directory: .

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## Alchemy Infrastructure Preview'

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body-path: /tmp/report.md
