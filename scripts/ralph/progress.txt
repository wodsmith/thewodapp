# Ralph Progress Log
Started: 2026-01-19
Feature: Volunteer Scheduler for Non-Judge Roles

## Codebase Patterns

### Database Schema Patterns
- Tables defined in `src/db/schemas/*.ts` using Drizzle ORM
- Common columns (id, createdAt, updatedAt) via `commonColumns` from `src/db/schemas/common.ts`
- ID generators follow pattern: `createXxxId()` in common.ts using CUID2
- Timestamps use `integer({ mode: "timestamp" })` for D1 compatibility
- Relations defined after table definition using `relations()` from drizzle-orm
- Indexes use `index()` and `uniqueIndex()` in table third argument

### Server Function Patterns
- Server functions in `src/server-fns/*.ts` files
- Use `createServerFn` from `@tanstack/react-start`
- Input validation with `.validator()` using Zod
- Handler chaining with `.handler()`
- Authorization via `requireTeamPermission()` from `src/utils/team-auth.ts`
- Example structure:
  ```typescript
  export const myFn = createServerFn({ method: "GET" })
    .validator(z.object({ ... }))
    .handler(async ({ data }) => { ... })
  ```

### Volunteer System Patterns
- Volunteer roles defined in `VOLUNTEER_ROLE_TYPES` constant
- Volunteer metadata stored as JSON in `teamMembershipTable.metadata`
- Judge rotations use heat-based scheduling (ties to competition heats)
- New shift system will use time-based scheduling (standalone time slots)

### Component Patterns
- Route components in `src/routes/` following TanStack Router file-based routing
- Shared components in `src/routes/*/-components/` directories (co-located with routes)
- Use Shadcn UI components from `src/components/ui/`
- Forms use React Hook Form with Zod validation

## Key Files

### Schema Files
- `src/db/schemas/volunteers.ts` - Volunteer roles, rotations, assignments
- `src/db/schemas/common.ts` - Common columns, ID generators
- `src/db/schemas/competitions.ts` - Competition heats, venues

### Server Functions
- `src/server-fns/volunteer-fns.ts` - Volunteer management (invite, approve, roles)
- `src/server-fns/volunteer-schedule-fns.ts` - Fetch volunteer schedule data
- `src/server-fns/judge-rotation-fns.ts` - Judge rotation CRUD

### UI Components
- `src/routes/compete/$slug/my-schedule.tsx` - Volunteer's schedule page
- `src/routes/compete/$slug/-components/schedule-view.tsx` - Schedule display component
- `src/routes/compete/$slug/-components/rotation-card.tsx` - Judge rotation card
- `src/routes/compete/organizer/$competitionId/-components/judges/` - Judge scheduling admin UI

### Utility Files
- `src/utils/team-auth.ts` - Permission checking helpers
- `src/utils/date-utils.ts` - Date formatting utilities
- `src/utils/batch-query.ts` - autochunk for D1 parameter limits

## Out of Scope
- Equipment team scheduling (needs special scheduling between heat division changes)
- Judge rotation system (already exists and works well)

## Target Volunteer Roles for Shift Scheduling
- medical
- check_in
- staff
- scorekeeper
- emcee
- floor_manager
- media
- general

(Note: judge, head_judge use existing rotation system; equipment is out of scope)

---

## Session Progress

### 2026-01-19 - Initial Setup
- PRD created with 16 user stories
- Stories prioritized by dependency order
- Context documented in this file

## 2026-01-19 - VS-001: Create volunteer_shifts schema
- Added `createVolunteerShiftId()` function to `src/db/schemas/common.ts` (prefix: `vshft_`)
- Added `volunteerShiftsTable` to `src/db/schemas/volunteers.ts` with:
  - Columns: id, competitionId, name, roleType, startTime (integer timestamp), endTime (integer timestamp), location (optional), capacity (default 1), notes (optional), createdAt, updatedAt
  - Foreign key to competitions table with cascade delete
  - Indexes on competitionId and startTime
- Added `VolunteerShift` type export
- Added `volunteerShiftsRelations` (shift -> competition)
- Updated `competitionsVolunteerSystemReverseRelations` (renamed from competitionsJudgeRotationsReverseRelations) to include both judgeRotations and volunteerShifts
- Created migration `0074_add-volunteer-shifts.sql`

**Files changed:**
- `apps/wodsmith-start/src/db/schemas/common.ts`
- `apps/wodsmith-start/src/db/schemas/volunteers.ts`
- `apps/wodsmith-start/src/db/migrations/0074_add-volunteer-shifts.sql`
- `apps/wodsmith-start/src/db/migrations/meta/_journal.json`

**Learnings:**
- `pnpm db:generate` doesn't accept migration name as positional argument - use `--name` flag or `--custom` for custom migrations
- `drizzle-kit generate` can get stuck in interactive mode if it detects schema changes it can't auto-resolve; using `--custom` bypasses this
- Multiple `relations()` calls for the same table in Drizzle ORM should be consolidated into a single call per table, or use unique relation names
- The snapshot files in `meta/` are auto-generated when using `--custom` flag
- Always verify existing migration patterns before creating new ones (e.g., timestamp column mode, foreign key patterns)
---

## 2026-01-19 - VS-002: Create volunteer_shift_assignments schema
- Added `createVolunteerShiftAssignmentId()` function to `src/db/schemas/common.ts` (prefix: `vshfta_`)
- Added `volunteerShiftAssignmentsTable` to `src/db/schemas/volunteers.ts` with:
  - Columns: id, shiftId, membershipId, notes (optional), createdAt, updatedAt
  - Foreign keys to volunteer_shifts and team_membership with cascade delete
  - Indexes on shiftId and membershipId
  - Unique constraint on (shiftId, membershipId) to prevent duplicate assignments
- Added `VolunteerShiftAssignment` type export
- Added `volunteerShiftAssignmentsRelations` (assignment -> shift, membership)
- Updated `volunteerShiftsRelations` to include `assignments` (many relation)
- Renamed `teamMembershipJudgeAssignmentsReverseRelations` to `teamMembershipVolunteerReverseRelations` to include `volunteerShiftAssignments`
- Created migration `0075_add-volunteer-shift-assignments.sql`

**Files changed:**
- `apps/wodsmith-start/src/db/schemas/common.ts`
- `apps/wodsmith-start/src/db/schemas/volunteers.ts`
- `apps/wodsmith-start/src/db/migrations/0075_add-volunteer-shift-assignments.sql`
- `apps/wodsmith-start/src/db/migrations/meta/_journal.json`
- `apps/wodsmith-start/src/db/migrations/meta/0075_snapshot.json`

**Learnings:**
- When adding a junction table, remember to update reverse relations on both parent tables
- Follow the judgeHeatAssignmentsTable pattern for junction tables: commonColumns, id, foreign keys, optional notes, indexes, unique constraint
- The `--custom` flag creates an empty migration file that needs manual SQL
- Rename relations when their scope expands (e.g., judge-specific -> all volunteer types)
---

## 2026-01-19 - VS-003: Apply volunteer shift migrations
- Applied migrations 0074 and 0075 to local D1 database successfully
- Both `volunteer_shifts` and `volunteer_shift_assignments` tables created with:
  - Proper columns and constraints
  - Foreign key cascade deletes working
  - Indexes on competitionId, startTime, shiftId, membershipId
  - Unique constraint on (shiftId, membershipId)
- All 75 migrations applied successfully to fresh local database
- Created `.alchemy/local/wrangler.jsonc` for local development (gitignored)

**Files changed:**
- `.alchemy/local/wrangler.jsonc` (created, gitignored - for local db:migrate:local support)

**Learnings:**
- The command is `pnpm db:migrate:local` (not `db:migrate:dev` as AGENTS.md suggests)
- Local migrations require `.alchemy/local/wrangler.jsonc` config file with D1 database configuration
- Running `pnpm alchemy:dev` requires Cloudflare credentials; for local migration testing, manually create minimal wrangler.jsonc
- The local wrangler config should reference `src/db/migrations` relative path for migrations_dir
- D1 migration output shows checkmark for applied, clock emoji for pending during batch apply
- Both volunteer shift tables reference existing tables (competitions, team_membership) via foreign keys
---

## 2026-01-19 - VS-004: Create shift CRUD server functions
- Created new file `src/server-fns/volunteer-shift-fns.ts` with four server functions:
  - `createShiftFn` - creates a new shift with validation (name, roleType, startTime, endTime required)
  - `getCompetitionShiftsFn` - gets all shifts for a competition, ordered by startTime, includes assignments with volunteer details
  - `updateShiftFn` - updates a shift by id with partial update support
  - `deleteShiftFn` - deletes a shift by id (cascade deletes assignments via foreign key)
- All functions validate competitionId and check user has organizer permission via `requireTeamPermission(organizingTeamId, TEAM_PERMISSIONS.MANAGE_COMPETITIONS)`
- Input validation using Zod schemas with proper error messages
- Helper function `getCompetitionWithAuthCheck` centralizes competition lookup and authorization
- Validated end time must be after start time for create and update operations

**Files changed:**
- `apps/wodsmith-start/src/server-fns/volunteer-shift-fns.ts` (new file, 264 lines)

**Learnings:**
- Use `.inputValidator((data: unknown) => z.object({...}).parse(data))` not `.validator()` - the pattern differs from the newer TanStack Start docs
- The `asc` ordering function is imported from `drizzle-orm` for orderBy clauses
- For nullable optional fields in update operations, use pattern: `data.field !== undefined ? (data.field ?? undefined) : undefined` to distinguish between "not provided" and "set to null"
- Competition authorization checks should go through the competition's `organizingTeamId` - that's the team with MANAGE_COMPETITIONS permission
- The shift ID prefix is `vshf_` (defined in common.ts as createVolunteerShiftId)
---

## 2026-01-19 - VS-005: Create shift assignment server functions
- Added five server functions to `src/server-fns/volunteer-shift-fns.ts`:
  - `assignVolunteerToShiftFn` - assigns a volunteer to a shift, validates capacity not exceeded
  - `unassignVolunteerFromShiftFn` - removes a volunteer from a shift
  - `getShiftAssignmentsFn` - gets all assignments for a shift with volunteer details (name, email, roleTypes)
  - `getVolunteerShiftsFn` - gets all shift assignments for a specific volunteer (by membershipId + competitionId)
  - `bulkAssignVolunteersToShiftFn` - assigns multiple volunteers to a shift at once with capacity validation
- Added helper function `getShiftWithAuthCheck` for shift lookup with permission validation
- Added helper function `parseVolunteerRoleTypes` to extract roleTypes from membership metadata JSON
- All functions validate capacity constraints (shift.capacity vs current assignment count)
- All functions check user has organizer permission via `requireTeamPermission`
- bulkAssignVolunteersToShiftFn uses autochunk for D1 parameter limits when verifying memberships exist
- Bulk insert uses batching (15 rows per batch) to stay under D1's 100 parameter limit

**Files changed:**
- `apps/wodsmith-start/src/server-fns/volunteer-shift-fns.ts` (added assignment functions, ~250 new lines)

**Learnings:**
- Drizzle relational queries with nested `with: { membership: { with: { user: true } } }` may not properly infer types when querying from junction tables; use join queries instead for explicit type control
- User table has `firstName` and `lastName` fields, not a single `name` field - combine them with `[firstName, lastName].filter(Boolean).join(" ")`
- For bulk inserts, D1 parameter count = columns * rows; volunteerShiftAssignmentsTable has ~6 columns, so safe batch size is ~15 rows
- Use `autochunk` from `@/utils/batch-query` for verifying membership IDs exist when the array size could exceed D1's 100 parameter limit
- The shift assignment ID prefix is `vsha_` (defined in common.ts as createVolunteerShiftAssignmentId)
---

