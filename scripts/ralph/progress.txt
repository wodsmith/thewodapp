# Ralph Progress Log
Started: 2026-01-19
Feature: Volunteer Scheduler for Non-Judge Roles

## Codebase Patterns

### Database Schema Patterns
- Tables defined in `src/db/schemas/*.ts` using Drizzle ORM
- Common columns (id, createdAt, updatedAt) via `commonColumns` from `src/db/schemas/common.ts`
- ID generators follow pattern: `createXxxId()` in common.ts using CUID2
- Timestamps use `integer({ mode: "timestamp" })` for D1 compatibility
- Relations defined after table definition using `relations()` from drizzle-orm
- Indexes use `index()` and `uniqueIndex()` in table third argument

### Server Function Patterns
- Server functions in `src/server-fns/*.ts` files
- Use `createServerFn` from `@tanstack/react-start`
- Input validation with `.validator()` using Zod
- Handler chaining with `.handler()`
- Authorization via `requireTeamPermission()` from `src/utils/team-auth.ts`
- Example structure:
  ```typescript
  export const myFn = createServerFn({ method: "GET" })
    .validator(z.object({ ... }))
    .handler(async ({ data }) => { ... })
  ```

### Volunteer System Patterns
- Volunteer roles defined in `VOLUNTEER_ROLE_TYPES` constant
- Volunteer metadata stored as JSON in `teamMembershipTable.metadata`
- Judge rotations use heat-based scheduling (ties to competition heats)
- New shift system will use time-based scheduling (standalone time slots)

### Component Patterns
- Route components in `src/routes/` following TanStack Router file-based routing
- Shared components in `src/routes/*/-components/` directories (co-located with routes)
- Use Shadcn UI components from `src/components/ui/`
- Forms use React Hook Form with Zod validation

## Key Files

### Schema Files
- `src/db/schemas/volunteers.ts` - Volunteer roles, rotations, assignments
- `src/db/schemas/common.ts` - Common columns, ID generators
- `src/db/schemas/competitions.ts` - Competition heats, venues

### Server Functions
- `src/server-fns/volunteer-fns.ts` - Volunteer management (invite, approve, roles)
- `src/server-fns/volunteer-schedule-fns.ts` - Fetch volunteer schedule data
- `src/server-fns/judge-rotation-fns.ts` - Judge rotation CRUD

### UI Components
- `src/routes/compete/$slug/my-schedule.tsx` - Volunteer's schedule page
- `src/routes/compete/$slug/-components/schedule-view.tsx` - Schedule display component
- `src/routes/compete/$slug/-components/rotation-card.tsx` - Judge rotation card
- `src/routes/compete/organizer/$competitionId/-components/judges/` - Judge scheduling admin UI

### Utility Files
- `src/utils/team-auth.ts` - Permission checking helpers
- `src/utils/date-utils.ts` - Date formatting utilities
- `src/utils/batch-query.ts` - autochunk for D1 parameter limits

## Out of Scope
- Equipment team scheduling (needs special scheduling between heat division changes)
- Judge rotation system (already exists and works well)

## Target Volunteer Roles for Shift Scheduling
- medical
- check_in
- staff
- scorekeeper
- emcee
- floor_manager
- media
- general

(Note: judge, head_judge use existing rotation system; equipment is out of scope)

---

## Session Progress

### 2026-01-19 - Initial Setup
- PRD created with 16 user stories
- Stories prioritized by dependency order
- Context documented in this file

## 2026-01-19 - VS-001: Create volunteer_shifts schema
- Added `createVolunteerShiftId()` function to `src/db/schemas/common.ts` (prefix: `vshft_`)
- Added `volunteerShiftsTable` to `src/db/schemas/volunteers.ts` with:
  - Columns: id, competitionId, name, roleType, startTime (integer timestamp), endTime (integer timestamp), location (optional), capacity (default 1), notes (optional), createdAt, updatedAt
  - Foreign key to competitions table with cascade delete
  - Indexes on competitionId and startTime
- Added `VolunteerShift` type export
- Added `volunteerShiftsRelations` (shift -> competition)
- Updated `competitionsVolunteerSystemReverseRelations` (renamed from competitionsJudgeRotationsReverseRelations) to include both judgeRotations and volunteerShifts
- Created migration `0074_add-volunteer-shifts.sql`

**Files changed:**
- `apps/wodsmith-start/src/db/schemas/common.ts`
- `apps/wodsmith-start/src/db/schemas/volunteers.ts`
- `apps/wodsmith-start/src/db/migrations/0074_add-volunteer-shifts.sql`
- `apps/wodsmith-start/src/db/migrations/meta/_journal.json`

**Learnings:**
- `pnpm db:generate` doesn't accept migration name as positional argument - use `--name` flag or `--custom` for custom migrations
- `drizzle-kit generate` can get stuck in interactive mode if it detects schema changes it can't auto-resolve; using `--custom` bypasses this
- Multiple `relations()` calls for the same table in Drizzle ORM should be consolidated into a single call per table, or use unique relation names
- The snapshot files in `meta/` are auto-generated when using `--custom` flag
- Always verify existing migration patterns before creating new ones (e.g., timestamp column mode, foreign key patterns)
---

## 2026-01-19 - VS-002: Create volunteer_shift_assignments schema
- Added `createVolunteerShiftAssignmentId()` function to `src/db/schemas/common.ts` (prefix: `vshfta_`)
- Added `volunteerShiftAssignmentsTable` to `src/db/schemas/volunteers.ts` with:
  - Columns: id, shiftId, membershipId, notes (optional), createdAt, updatedAt
  - Foreign keys to volunteer_shifts and team_membership with cascade delete
  - Indexes on shiftId and membershipId
  - Unique constraint on (shiftId, membershipId) to prevent duplicate assignments
- Added `VolunteerShiftAssignment` type export
- Added `volunteerShiftAssignmentsRelations` (assignment -> shift, membership)
- Updated `volunteerShiftsRelations` to include `assignments` (many relation)
- Renamed `teamMembershipJudgeAssignmentsReverseRelations` to `teamMembershipVolunteerReverseRelations` to include `volunteerShiftAssignments`
- Created migration `0075_add-volunteer-shift-assignments.sql`

**Files changed:**
- `apps/wodsmith-start/src/db/schemas/common.ts`
- `apps/wodsmith-start/src/db/schemas/volunteers.ts`
- `apps/wodsmith-start/src/db/migrations/0075_add-volunteer-shift-assignments.sql`
- `apps/wodsmith-start/src/db/migrations/meta/_journal.json`
- `apps/wodsmith-start/src/db/migrations/meta/0075_snapshot.json`

**Learnings:**
- When adding a junction table, remember to update reverse relations on both parent tables
- Follow the judgeHeatAssignmentsTable pattern for junction tables: commonColumns, id, foreign keys, optional notes, indexes, unique constraint
- The `--custom` flag creates an empty migration file that needs manual SQL
- Rename relations when their scope expands (e.g., judge-specific -> all volunteer types)
---

## 2026-01-19 - VS-003: Apply volunteer shift migrations
- Applied migrations 0074 and 0075 to local D1 database successfully
- Both `volunteer_shifts` and `volunteer_shift_assignments` tables created with:
  - Proper columns and constraints
  - Foreign key cascade deletes working
  - Indexes on competitionId, startTime, shiftId, membershipId
  - Unique constraint on (shiftId, membershipId)
- All 75 migrations applied successfully to fresh local database
- Created `.alchemy/local/wrangler.jsonc` for local development (gitignored)

**Files changed:**
- `.alchemy/local/wrangler.jsonc` (created, gitignored - for local db:migrate:local support)

**Learnings:**
- The command is `pnpm db:migrate:local` (not `db:migrate:dev` as AGENTS.md suggests)
- Local migrations require `.alchemy/local/wrangler.jsonc` config file with D1 database configuration
- Running `pnpm alchemy:dev` requires Cloudflare credentials; for local migration testing, manually create minimal wrangler.jsonc
- The local wrangler config should reference `src/db/migrations` relative path for migrations_dir
- D1 migration output shows checkmark for applied, clock emoji for pending during batch apply
- Both volunteer shift tables reference existing tables (competitions, team_membership) via foreign keys
---

## 2026-01-19 - VS-004: Create shift CRUD server functions
- Created new file `src/server-fns/volunteer-shift-fns.ts` with four server functions:
  - `createShiftFn` - creates a new shift with validation (name, roleType, startTime, endTime required)
  - `getCompetitionShiftsFn` - gets all shifts for a competition, ordered by startTime, includes assignments with volunteer details
  - `updateShiftFn` - updates a shift by id with partial update support
  - `deleteShiftFn` - deletes a shift by id (cascade deletes assignments via foreign key)
- All functions validate competitionId and check user has organizer permission via `requireTeamPermission(organizingTeamId, TEAM_PERMISSIONS.MANAGE_COMPETITIONS)`
- Input validation using Zod schemas with proper error messages
- Helper function `getCompetitionWithAuthCheck` centralizes competition lookup and authorization
- Validated end time must be after start time for create and update operations

**Files changed:**
- `apps/wodsmith-start/src/server-fns/volunteer-shift-fns.ts` (new file, 264 lines)

**Learnings:**
- Use `.inputValidator((data: unknown) => z.object({...}).parse(data))` not `.validator()` - the pattern differs from the newer TanStack Start docs
- The `asc` ordering function is imported from `drizzle-orm` for orderBy clauses
- For nullable optional fields in update operations, use pattern: `data.field !== undefined ? (data.field ?? undefined) : undefined` to distinguish between "not provided" and "set to null"
- Competition authorization checks should go through the competition's `organizingTeamId` - that's the team with MANAGE_COMPETITIONS permission
- The shift ID prefix is `vshf_` (defined in common.ts as createVolunteerShiftId)
---

## 2026-01-19 - VS-005: Create shift assignment server functions
- Added five server functions to `src/server-fns/volunteer-shift-fns.ts`:
  - `assignVolunteerToShiftFn` - assigns a volunteer to a shift, validates capacity not exceeded
  - `unassignVolunteerFromShiftFn` - removes a volunteer from a shift
  - `getShiftAssignmentsFn` - gets all assignments for a shift with volunteer details (name, email, roleTypes)
  - `getVolunteerShiftsFn` - gets all shift assignments for a specific volunteer (by membershipId + competitionId)
  - `bulkAssignVolunteersToShiftFn` - assigns multiple volunteers to a shift at once with capacity validation
- Added helper function `getShiftWithAuthCheck` for shift lookup with permission validation
- Added helper function `parseVolunteerRoleTypes` to extract roleTypes from membership metadata JSON
- All functions validate capacity constraints (shift.capacity vs current assignment count)
- All functions check user has organizer permission via `requireTeamPermission`
- bulkAssignVolunteersToShiftFn uses autochunk for D1 parameter limits when verifying memberships exist
- Bulk insert uses batching (15 rows per batch) to stay under D1's 100 parameter limit

**Files changed:**
- `apps/wodsmith-start/src/server-fns/volunteer-shift-fns.ts` (added assignment functions, ~250 new lines)

**Learnings:**
- Drizzle relational queries with nested `with: { membership: { with: { user: true } } }` may not properly infer types when querying from junction tables; use join queries instead for explicit type control
- User table has `firstName` and `lastName` fields, not a single `name` field - combine them with `[firstName, lastName].filter(Boolean).join(" ")`
- For bulk inserts, D1 parameter count = columns * rows; volunteerShiftAssignmentsTable has ~6 columns, so safe batch size is ~15 rows
- Use `autochunk` from `@/utils/batch-query` for verifying membership IDs exist when the array size could exceed D1's 100 parameter limit
- The shift assignment ID prefix is `vsha_` (defined in common.ts as createVolunteerShiftAssignmentId)
---

## 2026-01-19 - VS-006: Extend volunteer schedule data fetching
- Updated `getVolunteerScheduleDataFn` in `src/server-fns/volunteer-schedule-fns.ts` to fetch volunteer shift assignments
- Added new type interfaces:
  - `VolunteerShiftData` - individual shift with id, name, roleType, startTime, endTime, location, notes
  - `VolunteerScheduleData` - combined return type with events and shifts arrays
- Query joins `volunteerShiftAssignmentsTable` with `volunteerShiftsTable` to get shift details for the volunteer
- Shifts are ordered by startTime ascending
- Backward compatible: events array structure unchanged, shifts added as new field
- Return type changed from `{ events: EventWithRotations[] }` to `VolunteerScheduleData`
- Handle case where volunteer has shifts but no judge rotations (still return valid response)

**Files changed:**
- `apps/wodsmith-start/src/server-fns/volunteer-schedule-fns.ts` (updated, +62 lines)

**Learnings:**
- When extending return types, create a new interface (VolunteerScheduleData) rather than modifying inline types for better type exports
- Import additional tables and types as needed - volunteerShiftsTable, volunteerShiftAssignmentsTable, VolunteerRoleType
- When function has early return, ensure it includes all new fields (shifts array, not just events)
- Use innerJoin when the relationship is required (every assignment must have a shift)
- For time-based ordering, use `getTime()` on Date objects for numeric comparison in sort callback
---

## 2026-01-19 - VS-007: Create shift card component
- Created `src/routes/compete/$slug/-components/shift-card.tsx` with ShiftCard component
- Component displays:
  - Shift name as header
  - Role type badge with distinct colors for each volunteer role type
  - Time range in user-friendly format (e.g., "Sat 8:00 AM - 12:00 PM")
  - Location with MapPin icon (conditionally shown when set)
  - Notes section with distinct blue styling (conditionally shown when set)
- Styling patterns:
  - Border-left accent (primary for upcoming, muted with opacity for past shifts)
  - Card/CardContent from Shadcn UI
  - Clock and MapPin icons from lucide-react
  - Role-specific badge colors (blue for judge, red for medical, green for check_in, etc.)
- Time formatting uses Intl.DateTimeFormat for localization
- Handles edge case of shifts spanning multiple days (shows both day abbreviations)
- Follows responsive design patterns from existing rotation-card.tsx

**Files changed:**
- `apps/wodsmith-start/src/routes/compete/$slug/-components/shift-card.tsx` (new file, ~145 lines)

**Learnings:**
- Follow existing component patterns for consistency (rotation-card.tsx for card structure, volunteer-profile-card.tsx for role formatting)
- The `formatRoleType` function exists in volunteer-profile-card.tsx but is local; recreated in shift-card for now (could be extracted to shared utils later)
- Use `cn()` utility from `@/utils/cn` for conditional class merging
- Intl.DateTimeFormat handles time formatting with proper AM/PM and localization
- For badge colors, use semantic Tailwind color names that have dark mode variants (e.g., bg-blue-100 dark:bg-blue-900)
- VolunteerShiftData type is exported from volunteer-schedule-fns.ts and can be imported directly
---

## 2026-01-19 - VS-008 & VS-009: Update schedule-view for shifts and my-schedule page loader
- Updated `schedule-view.tsx` to accept `shifts` prop of type `VolunteerShiftData[]`
- Added "My Shifts" section after volunteer profile card with:
  - Section title "My Shifts"
  - ShiftCard component for each shift
  - Empty state: "No shifts assigned yet" in a dashed border box
- Updated page title logic:
  - Shows "My Judging Schedule" only if judge with events and no shifts
  - Shows "My Volunteer Schedule" in all other cases (shifts exist, or generic volunteer)
- Updated `my-schedule.tsx` loader to:
  - Destructure `shifts` from `getVolunteerScheduleDataFn` result
  - Include `shifts: []` in early return cases (no team, no membership)
  - Pass `shifts` prop to ScheduleView component
- Events/judging section now conditionally renders only when `hasEvents` is true

**Files changed:**
- `apps/wodsmith-start/src/routes/compete/$slug/-components/schedule-view.tsx` (updated, +30 lines)
- `apps/wodsmith-start/src/routes/compete/$slug/my-schedule.tsx` (updated, +5 lines)

**Learnings:**
- When adding new props to a component, update all consuming components (found my-schedule.tsx needed shifts prop)
- For conditional rendering with two boolean flags (hasEvents, hasShifts), consider all four states in the logic
- The empty state condition changed from `events.length === 0` to `!hasEvents && !hasShifts` to properly handle shifts-only volunteers
- TanStack Router's useLoaderData returns typed data based on the loader return type - updating loader return automatically updates component types
- Import multiple types from the same module using grouped import: `import type { EventWithRotations, VolunteerShiftData } from "..."`
---

## 2026-01-19 - VS-010: Create admin shift list component
- Created `src/routes/compete/organizer/$competitionId/-components/shifts/shift-list.tsx`
- Component features:
  - Groups shifts by date with date headers (e.g., "Monday, Jan 20")
  - Each shift displays: name, role type badge, time range, location (if set), assigned/capacity count
  - Add Shift button (placeholder for VS-011 dialog)
  - Edit button on each shift (placeholder for VS-011 dialog)
  - Delete button with confirmation AlertDialog
  - Empty state with icon and Add Shift CTA
- Styled with Shadcn UI components:
  - Table for shift list within each day group
  - Card for day groupings
  - Badge for role type and capacity display
  - AlertDialog for delete confirmation
- Delete confirmation shows shift name and warns about assigned volunteers
- Uses `useServerFn` hook for `deleteShiftFn` calls
- Type inferred from `getCompetitionShiftsFn` return type using `Awaited<ReturnType<typeof getCompetitionShiftsFn>>[number]`
- Role type labels map for display (ROLE_TYPE_LABELS constant)

**Files changed:**
- `apps/wodsmith-start/src/routes/compete/organizer/$competitionId/-components/shifts/shift-list.tsx` (new file, ~280 lines)

**Learnings:**
- Infer types from server function return types using `Awaited<ReturnType<typeof fnName>>` pattern
- For list items, index into the array type with `[number]`
- Group items by date using Map with date key string (YYYY-MM-DD format)
- Use `toLocaleTimeString` and `toLocaleDateString` for user-friendly time/date formatting
- AlertDialog component from Shadcn uses controlled state with open prop
- For props that will be used in future stories, use underscore prefix and void statement to suppress unused warnings
- Follow existing patterns from waiver-list.tsx (delete confirmation) and judge-overview.tsx (date grouping)
---

